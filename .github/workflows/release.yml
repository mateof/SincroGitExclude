name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS'
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ==========================================
  # Extract version and create release
  # ==========================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      should_release: ${{ steps.version.outputs.should_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Check if tag already exists
          if git ls-remote --tags origin "refs/tags/$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  # ==========================================
  # Build Windows (NSIS installer)
  # ==========================================
  build-windows:
    name: Build Windows
    needs: prepare
    if: |
      needs.prepare.outputs.should_release == 'true' &&
      (github.event_name == 'push' || inputs.build_windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        run: npm run build && npx electron-builder --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.exe
          retention-days: 5

  # ==========================================
  # Build macOS (DMG - x64 + arm64)
  # ==========================================
  build-macos-x64:
    name: Build macOS (Intel)
    needs: prepare
    if: |
      needs.prepare.outputs.should_release == 'true' &&
      (github.event_name == 'push' || inputs.build_macos)
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        run: npm run build && npx electron-builder --mac --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-dmg
          path: |
            dist/*.dmg
          retention-days: 5

  build-macos-arm64:
    name: Build macOS (Apple Silicon)
    needs: prepare
    if: |
      needs.prepare.outputs.should_release == 'true' &&
      (github.event_name == 'push' || inputs.build_macos)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        run: npm run build && npx electron-builder --mac --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-dmg
          path: |
            dist/*.dmg
          retention-days: 5

  # ==========================================
  # Build Linux (AppImage + deb)
  # ==========================================
  build-linux:
    name: Build Linux
    needs: prepare
    if: |
      needs.prepare.outputs.should_release == 'true' &&
      (github.event_name == 'push' || inputs.build_linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        run: npm run build && npx electron-builder --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.AppImage
            dist/*.deb
          retention-days: 5

  # ==========================================
  # Create GitHub Release and upload assets
  # ==========================================
  release:
    name: Create Release
    needs: [prepare, build-windows, build-macos-x64, build-macos-arm64, build-linux]
    if: |
      always() &&
      needs.prepare.outputs.should_release == 'true' &&
      (needs.build-windows.result == 'success' || needs.build-macos-x64.result == 'success' || needs.build-macos-arm64.result == 'success' || needs.build-linux.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build status summary
        run: |
          echo "Build Results:"
          echo "  Windows:             ${{ needs.build-windows.result }}"
          echo "  macOS Intel:         ${{ needs.build-macos-x64.result }}"
          echo "  macOS Apple Silicon: ${{ needs.build-macos-arm64.result }}"
          echo "  Linux:               ${{ needs.build-linux.result }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.prepare.outputs.tag }}
          VERSION=${{ needs.prepare.outputs.version }}

          # Create the release
          gh release create "$TAG" \
            --title "SincroGitExclude $VERSION" \
            --generate-notes \
            --latest

          # Upload all installer/package files with retry
          upload_with_retry() {
            local file=$1
            local max_attempts=5
            local attempt=1
            local delay=10

            while [ $attempt -le $max_attempts ]; do
              echo "Uploading $(basename $file) (attempt $attempt/$max_attempts)..."
              if gh release upload "$TAG" "$file" --clobber 2>&1; then
                echo "Uploaded $(basename $file)"
                return 0
              fi
              echo "Upload failed, retrying in ${delay}s..."
              sleep $delay
              delay=$((delay * 2))
              attempt=$((attempt + 1))
            done
            echo "Failed to upload $(basename $file)"
            return 1
          }

          find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" \) | while read file; do
            upload_with_retry "$file"
            sleep 2
          done

          echo "Release $TAG created!"
